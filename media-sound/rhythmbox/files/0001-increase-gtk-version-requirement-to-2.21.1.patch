From b602a2915d0896d5694c93fedea075ccc4bcac96 Mon Sep 17 00:00:00 2001
From: Marc-Antoine Perennou <Marc-Antoine@Perennou.com>
Date: Sun, 20 Jun 2010 19:14:54 +0200
Subject: [PATCH] increase gtk+ version requirement to 2.21.1

---
 configure.ac                                      |    2 +-
 doc/reference/Makefile.am                         |    1 -
 lib/Makefile.am                                   |    1 -
 lib/eggdesktopfile.c                              |    8 ---
 lib/gseal-gtk-compat.h                            |   54 ---------------------
 lib/rb-tree-dnd.c                                 |    8 ++--
 plugins/audioscrobbler/rb-lastfm-source.c         |    2 -
 plugins/cd-recorder/rb-cd-recorder-plugin.c       |    1 -
 plugins/cd-recorder/rb-playlist-source-recorder.c |    1 -
 plugins/status-icon/rb-status-icon-plugin.c       |    1 -
 plugins/visualizer/rb-vis-widget.c                |    2 -
 plugins/visualizer/rb-visualizer-plugin.c         |    1 -
 shell/rb-missing-plugins.c                        |    1 -
 shell/rb-plugin-manager.c                         |    2 -
 shell/rb-shell.c                                  |    1 -
 sources/rb-sourcelist-model.c                     |    5 +-
 widgets/gossip-cell-renderer-expander.c           |    2 -
 widgets/rb-cell-renderer-pixbuf.c                 |    1 -
 widgets/rb-cell-renderer-rating.c                 |    1 -
 widgets/rb-entry-view.c                           |    1 -
 widgets/rb-library-browser.c                      |    1 -
 widgets/rb-rating-helper.c                        |    1 -
 widgets/rb-rating.c                               |    2 -
 23 files changed, 8 insertions(+), 92 deletions(-)
 delete mode 100644 lib/gseal-gtk-compat.h

diff --git a/configure.ac b/configure.ac
index 3208df0..38daa4b 100644
--- a/configure.ac
+++ b/configure.ac
@@ -42,7 +42,7 @@ AC_CHECK_SIZEOF(long)
 
 DBUS_MIN_REQS=0.35
 GST_0_10_REQS=0.10.20
-GTK_REQS=2.18.0
+GTK_REQS=2.21.1
 GLIB_REQS=2.18.0
 GNOME_MEDIA_PROFILES_REQS=2.8
 LIBNOTIFY_REQS=0.4.1
diff --git a/doc/reference/Makefile.am b/doc/reference/Makefile.am
index a76394d..d989fa3 100644
--- a/doc/reference/Makefile.am
+++ b/doc/reference/Makefile.am
@@ -34,7 +34,6 @@ IGNORE_HFILES= \
 	eggdesktopfile.h \
 	eggsmclient-private.h \
 	eggsmclient.h \
-	gseal-gtk-compat.h \
 	md5.h \
 	mkdtemp.h \
 	rb-cut-and-paste-code.h \
diff --git a/lib/Makefile.am b/lib/Makefile.am
index 0cd73da..7a5e042 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -31,7 +31,6 @@ librb_la_SOURCES =					\
 	eggsmclient.h					\
 	eggsmclient-private.h				\
 	eggsmclient-xsmp.c				\
-	gseal-gtk-compat.h				\
 	rb-file-helpers.c				\
 	rb-builder-helpers.c				\
 	rb-stock-icons.c				\
diff --git a/lib/eggdesktopfile.c b/lib/eggdesktopfile.c
index 357e548..c415c91 100644
--- a/lib/eggdesktopfile.c
+++ b/lib/eggdesktopfile.c
@@ -909,7 +909,6 @@ parse_link (EggDesktopFile  *desktop_file,
   return TRUE;
 }
 
-#if GTK_CHECK_VERSION (2, 12, 0)
 static char *
 start_startup_notification (GdkDisplay     *display,
 			    EggDesktopFile *desktop_file,
@@ -1020,7 +1019,6 @@ set_startup_notification_timeout (GdkDisplay *display,
   g_timeout_add_seconds (EGG_DESKTOP_FILE_SN_TIMEOUT_LENGTH,
 			 startup_notification_timeout, sn_data);
 }
-#endif /* GTK 2.12 */
 
 static GPtrArray *
 array_putenv (GPtrArray *env, char *variable)
@@ -1207,7 +1205,6 @@ egg_desktop_file_launchv (EggDesktopFile *desktop_file,
 	}
       g_free (command);
 
-#if GTK_CHECK_VERSION (2, 12, 0)
       startup_id = start_startup_notification (display, desktop_file,
 					       argv[0], screen_num,
 					       workspace, launch_time);
@@ -1218,9 +1215,6 @@ egg_desktop_file_launchv (EggDesktopFile *desktop_file,
 	  env = array_putenv (env, startup_id_env);
 	  g_free (startup_id_env);
 	}
-#else
-      startup_id = NULL;
-#endif /* GTK 2.12 */
 
       if (env != NULL)
 	g_ptr_array_add (env, NULL);
@@ -1238,7 +1232,6 @@ egg_desktop_file_launchv (EggDesktopFile *desktop_file,
 
       if (startup_id)
 	{
-#if GTK_CHECK_VERSION (2, 12, 0)
 	  if (current_success)
 	    {
 	      set_startup_notification_timeout (display, startup_id);
@@ -1249,7 +1242,6 @@ egg_desktop_file_launchv (EggDesktopFile *desktop_file,
 		g_free (startup_id);
 	    }
 	  else
-#endif /* GTK 2.12 */
 	    g_free (startup_id);
 	}
       else if (ret_startup_id)
diff --git a/lib/gseal-gtk-compat.h b/lib/gseal-gtk-compat.h
deleted file mode 100644
index a839073..0000000
--- a/lib/gseal-gtk-compat.h
+++ /dev/null
@@ -1,54 +0,0 @@
-/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 8 -*- */
-/*
- *  Copyright © 2009 Thomas H.P. Andersen <phomes@gmail.com>,
- *              2009 Javier Jardón <jjardon@gnome.org>
- *
- *  This runtime is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU Lesser General Public License as published by
- *  the Free Software Foundation; either version 2.1, or (at your option)
- *  any later version.
- *
- *  This runtime is distributed in the hope runtime it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU Lesser General Public License
- *  along with this runtime; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#ifndef GSEAL_GTK_COMPAT_H
-#define GSEAL_GTK_COMPAT_H
-
-G_BEGIN_DECLS
-
-#if !GTK_CHECK_VERSION (2, 19, 5)
-#define gtk_widget_get_realized(widget)				GTK_WIDGET_REALIZED(widget)
-#define gtk_widget_set_realized(widget, TRUE)			GTK_WIDGET_SET_FLAGS(widget, GTK_REALIZED)
-#endif
-
-#if !GTK_CHECK_VERSION (2, 18, 0)
-#define gtk_widget_has_focus(widget)                            (GTK_WIDGET_HAS_FOCUS (widget))
-#define gtk_widget_is_drawable(widget)                          (GTK_WIDGET_DRAWABLE (widget))
-#define gtk_widget_get_allocation(widget, alloc)                (*(alloc)=(widget)->allocation)
-#define gtk_widget_get_app_paintable(widget)                    (GTK_WIDGET_APP_PAINTABLE (widget))
-#define gtk_widget_get_has_window(widget)                       (!GTK_WIDGET_NO_WINDOW (widget))
-#define gtk_widget_get_state(widget)                            ((widget)->state)
-#define gtk_widget_get_visible(widget)                          (GTK_WIDGET_VISIBLE (widget))
-#define gtk_widget_set_allocation(widget, alloc)                ((widget)->allocation=*(alloc))
-#define gtk_widget_set_can_default(widget, TRUE)                GTK_WIDGET_SET_FLAGS (widget, GTK_CAN_DEFAULT)
-#define gtk_widget_set_can_focus(widget, TRUE)                  GTK_WIDGET_SET_FLAGS (widget, GTK_CAN_FOCUS)
-#define gtk_widget_set_double_buffered(widget, FALSE)           GTK_WIDGET_UNSET_FLAGS (widget, GTK_DOUBLE_BUFFERED)
-#define gtk_widget_set_window(widget, _window)                  ((widget)->window=_window)
-#define gtk_widget_set_visible(widget, visible)			((visible?gtk_widget_show:gtk_widget_hide)(widget))
-
-#define gtk_cell_renderer_get_padding(cell, xpad, ypad)		g_object_get (cell, "xpad", xpad, "ypad", ypad, NULL);
-#define gtk_cell_renderer_get_alignment(cell, xalign, yalign)	g_object_get (cell, "xalign", xalign, "yalign", yalign, NULL);
-#define gtk_cell_renderer_set_padding(cell, xpad, ypad)		g_object_set (cell, "xpad", xpad, "ypad", ypad, NULL);
-
-#endif /* GTK+ < 2.18.0 */
-
-G_END_DECLS
-
-#endif /* GSEAL_GTK_COMPAT_H */
diff --git a/lib/rb-tree-dnd.c b/lib/rb-tree-dnd.c
index bc14700..8f7b0a6 100644
--- a/lib/rb-tree-dnd.c
+++ b/lib/rb-tree-dnd.c
@@ -448,7 +448,7 @@ filter_drop_position (GtkWidget *widget, GdkDragContext *context, GtkTreePath *p
 
 	ret = rb_tree_drag_dest_row_drop_position (RB_TREE_DRAG_DEST (model),
 						   path,
-						   context->targets,
+						   gdk_drag_context_list_targets (context),
 						   pos);
   
 	rb_debug ("filtered drop position: %s", ret ? "TRUE" : "FALSE");	
@@ -737,10 +737,10 @@ rb_tree_dnd_drag_motion_cb (GtkWidget        *widget,
 	}
 
 	if (GTK_WIDGET (tree_view) == gtk_drag_get_source_widget (context) &&
-	    context->actions & GDK_ACTION_MOVE)
+	    gdk_drag_context_get_actions (context) & GDK_ACTION_MOVE)
 		action = GDK_ACTION_MOVE;
 	else
-		action = context->suggested_action;
+		action = gdk_drag_context_get_suggested_action (context);
 
 	if (path) {
 		gtk_tree_view_set_drag_dest_row (tree_view, path, pos);
@@ -863,7 +863,7 @@ rb_tree_dnd_drag_data_received_cb (GtkWidget        *widget,
 
 	gtk_drag_finish (context,
         		 accepted,
-			 (context->action == GDK_ACTION_MOVE),
+			 (gdk_drag_context_get_selected_action (context) == GDK_ACTION_MOVE),
 			 time);
 
 	if (dest_row)
diff --git a/plugins/audioscrobbler/rb-lastfm-source.c b/plugins/audioscrobbler/rb-lastfm-source.c
index 492c7ca..c41bbcf 100644
--- a/plugins/audioscrobbler/rb-lastfm-source.c
+++ b/plugins/audioscrobbler/rb-lastfm-source.c
@@ -76,8 +76,6 @@
 #include "rb-play-order.h"
 #include "rb-lastfm-play-order.h"
 
-#include "gseal-gtk-compat.h"
-
 #define LASTFM_URL "ws.audioscrobbler.com"
 #define RB_LASTFM_PLATFORM "linux"
 #define RB_LASTFM_VERSION "1.5"
diff --git a/plugins/cd-recorder/rb-cd-recorder-plugin.c b/plugins/cd-recorder/rb-cd-recorder-plugin.c
index 493cb6e..2736ffa 100644
--- a/plugins/cd-recorder/rb-cd-recorder-plugin.c
+++ b/plugins/cd-recorder/rb-cd-recorder-plugin.c
@@ -43,7 +43,6 @@
 #include "rb-playlist-source.h"
 #include "rb-dialog.h"
 #include "rb-file-helpers.h"
-#include "gseal-gtk-compat.h"
 
 #include "rb-recorder.h"
 #include "rb-playlist-source-recorder.h"
diff --git a/plugins/cd-recorder/rb-playlist-source-recorder.c b/plugins/cd-recorder/rb-playlist-source-recorder.c
index c8c7e55..96ed41f 100644
--- a/plugins/cd-recorder/rb-playlist-source-recorder.c
+++ b/plugins/cd-recorder/rb-playlist-source-recorder.c
@@ -43,7 +43,6 @@
 
 #include <nautilus-burn.h>
 
-#include "gseal-gtk-compat.h"
 #include "rb-file-helpers.h"
 #include "rb-builder-helpers.h"
 #include "rb-preferences.h"
diff --git a/plugins/status-icon/rb-status-icon-plugin.c b/plugins/status-icon/rb-status-icon-plugin.c
index 5035d94..85e69f1 100644
--- a/plugins/status-icon/rb-status-icon-plugin.c
+++ b/plugins/status-icon/rb-status-icon-plugin.c
@@ -52,7 +52,6 @@
 #include "rb-stock-icons.h"
 #include "eel-gconf-extensions.h"
 #include "rb-builder-helpers.h"
-#include "gseal-gtk-compat.h"
 
 #include "rb-tray-icon-gtk.h"
 
diff --git a/plugins/visualizer/rb-vis-widget.c b/plugins/visualizer/rb-vis-widget.c
index 0835f6a..c1b0ceb 100644
--- a/plugins/visualizer/rb-vis-widget.c
+++ b/plugins/visualizer/rb-vis-widget.c
@@ -40,8 +40,6 @@
 #include "rb-vis-widget.h"
 #include "rb-debug.h"
 
-#include "gseal-gtk-compat.h"
-
 enum
 {
 	PROP_0,
diff --git a/plugins/visualizer/rb-visualizer-plugin.c b/plugins/visualizer/rb-visualizer-plugin.c
index 3430417..78cc40f 100644
--- a/plugins/visualizer/rb-visualizer-plugin.c
+++ b/plugins/visualizer/rb-visualizer-plugin.c
@@ -81,7 +81,6 @@
 #include <dbus/dbus-glib.h>
 
 #include "rb-vis-widget.h"
-#include "gseal-gtk-compat.h"
 
 /* preferences */
 #define CONF_VIS_PREFIX  CONF_PREFIX "/plugins/visualizer"
diff --git a/shell/rb-missing-plugins.c b/shell/rb-missing-plugins.c
index 0ec0ff7..f890626 100644
--- a/shell/rb-missing-plugins.c
+++ b/shell/rb-missing-plugins.c
@@ -29,7 +29,6 @@
 #include "rb-shell-player.h"
 #include "rb-debug.h"
 #include "rb-podcast-manager.h"
-#include "gseal-gtk-compat.h"
 
 #include <gst/pbutils/pbutils.h>
 #include <gst/pbutils/install-plugins.h>
diff --git a/shell/rb-plugin-manager.c b/shell/rb-plugin-manager.c
index dee908c..90387a3 100644
--- a/shell/rb-plugin-manager.c
+++ b/shell/rb-plugin-manager.c
@@ -43,8 +43,6 @@
 #include "rb-debug.h"
 #include "rb-builder-helpers.h"
 
-#include "gseal-gtk-compat.h"
-
 enum
 {
 	ACTIVE_COLUMN,
diff --git a/shell/rb-shell.c b/shell/rb-shell.c
index f58358c..1f70be2 100644
--- a/shell/rb-shell.c
+++ b/shell/rb-shell.c
@@ -52,7 +52,6 @@
 #include <X11/XF86keysym.h>
 #endif /* HAVE_MMKEYS */
 
-#include "gseal-gtk-compat.h"
 #include "rb-shell.h"
 #include "rb-debug.h"
 #include "rb-dialog.h"
diff --git a/sources/rb-sourcelist-model.c b/sources/rb-sourcelist-model.c
index fca3fc3..4d423fe 100644
--- a/sources/rb-sourcelist-model.c
+++ b/sources/rb-sourcelist-model.c
@@ -459,7 +459,8 @@ rb_sourcelist_model_get_drag_target (RbTreeDragDest *drag_dest,
 				     GtkTreePath *path,
 				     GtkTargetList *target_list)
 {
-	if (g_list_find (context->targets, gdk_atom_intern ("application/x-rhythmbox-source", TRUE))) {
+	if (g_list_find (gdk_drag_context_list_targets (context),
+            gdk_atom_intern ("application/x-rhythmbox-source", TRUE))) {
 		/* always accept rb source path if offered */
 		return gdk_atom_intern ("application/x-rhythmbox-source", TRUE);
 	}
@@ -469,7 +470,7 @@ rb_sourcelist_model_get_drag_target (RbTreeDragDest *drag_dest,
 		GdkAtom entry_atom;
 
 		entry_atom = gdk_atom_intern ("application/x-rhythmbox-entry", FALSE);
-		if (g_list_find (context->targets, entry_atom))
+		if (g_list_find (gdk_drag_context_list_targets (context), entry_atom))
 			return entry_atom;
 
 		return gdk_atom_intern ("text/uri-list", FALSE);
diff --git a/widgets/gossip-cell-renderer-expander.c b/widgets/gossip-cell-renderer-expander.c
index 0258d29..1c01011 100644
--- a/widgets/gossip-cell-renderer-expander.c
+++ b/widgets/gossip-cell-renderer-expander.c
@@ -33,8 +33,6 @@
 
 #include "gossip-cell-renderer-expander.h"
 
-#include "gseal-gtk-compat.h"
-
 #define GET_PRIV(obj) (G_TYPE_INSTANCE_GET_PRIVATE ((obj), GOSSIP_TYPE_CELL_RENDERER_EXPANDER, GossipCellRendererExpanderPriv))
 
 static void     gossip_cell_renderer_expander_init         (GossipCellRendererExpander      *expander);
diff --git a/widgets/rb-cell-renderer-pixbuf.c b/widgets/rb-cell-renderer-pixbuf.c
index 178b4b9..9f5cb1a 100644
--- a/widgets/rb-cell-renderer-pixbuf.c
+++ b/widgets/rb-cell-renderer-pixbuf.c
@@ -26,7 +26,6 @@
 #include <glib/gi18n.h>
 #include <gtk/gtk.h>
 
-#include "gseal-gtk-compat.h"
 #include "rb-cell-renderer-pixbuf.h"
 #include "rb-cut-and-paste-code.h"
 
diff --git a/widgets/rb-cell-renderer-rating.c b/widgets/rb-cell-renderer-rating.c
index 005f18f..f9d96c6 100644
--- a/widgets/rb-cell-renderer-rating.c
+++ b/widgets/rb-cell-renderer-rating.c
@@ -29,7 +29,6 @@
 #include <glib/gi18n.h>
 #include <gtk/gtk.h>
 
-#include "gseal-gtk-compat.h"
 #include "rb-cell-renderer-rating.h"
 #include "rb-marshal.h"
 #include "rb-rating-helper.h"
diff --git a/widgets/rb-entry-view.c b/widgets/rb-entry-view.c
index f8e3a20..f04c0aa 100644
--- a/widgets/rb-entry-view.c
+++ b/widgets/rb-entry-view.c
@@ -101,7 +101,6 @@
 #include "eel-gconf-extensions.h"
 #include "rb-shell-player.h"
 #include "rb-cut-and-paste-code.h"
-#include "gseal-gtk-compat.h"
 
 static const GtkTargetEntry rb_entry_view_drag_types[] = {
 	{ "application/x-rhythmbox-entry", 0, 0 },
diff --git a/widgets/rb-library-browser.c b/widgets/rb-library-browser.c
index 68c02fe..459c093 100644
--- a/widgets/rb-library-browser.c
+++ b/widgets/rb-library-browser.c
@@ -35,7 +35,6 @@
 #include <glib/gi18n.h>
 #include <gtk/gtk.h>
 
-#include "gseal-gtk-compat.h"
 #include "rb-library-browser.h"
 #include "rb-preferences.h"
 #include "eel-gconf-extensions.h"
diff --git a/widgets/rb-rating-helper.c b/widgets/rb-rating-helper.c
index 4018bee..4c6f8ba 100644
--- a/widgets/rb-rating-helper.c
+++ b/widgets/rb-rating-helper.c
@@ -33,7 +33,6 @@
 #include <gtk/gtk.h>
 #include <glib/gi18n.h>
 
-#include "gseal-gtk-compat.h"
 #include "rb-cut-and-paste-code.h"
 #include "rb-rating-helper.h"
 #include "rb-stock-icons.h"
diff --git a/widgets/rb-rating.c b/widgets/rb-rating.c
index 88f00c8..5a89836 100644
--- a/widgets/rb-rating.c
+++ b/widgets/rb-rating.c
@@ -37,8 +37,6 @@
 #include "rb-stock-icons.h"
 #include "rb-cut-and-paste-code.h"
 
-#include "gseal-gtk-compat.h"
-
 /* Offset at the beggining of the widget */
 #define X_OFFSET 0
 
-- 
1.7.1

