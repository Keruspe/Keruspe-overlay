From 5cc24283f57453c631e76d190ee065052ab9158e Mon Sep 17 00:00:00 2001
From: Marc-Antoine Perennou <Marc-Antoine@Perennou.com>
Date: Mon, 26 Jul 2010 18:38:14 +0200
Subject: [PATCH 2/3] paludis ask

---
 bash-completion/paludis                   |    2 ++
 doc/faq/misfunctionality.html.part        |    9 ---------
 paludis/args/legacy/install_args_group.cc |    1 +
 paludis/args/legacy/install_args_group.hh |    3 +++
 paludis/legacy/install_task.cc            |   22 ++++++++++++++++++++++
 paludis/legacy/install_task.hh            |    3 +++
 paludis/legacy/uninstall_task.cc          |   12 ++++++++++++
 paludis/legacy/uninstall_task.hh          |    3 +++
 src/clients/paludis/uninstall.cc          |   20 ++++++++++++++++++++
 src/output/console_install_task.cc        |   22 ++++++++++++++++++++++
 src/output/console_install_task.hh        |    2 ++
 zsh-completion/_paludis                   |    1 +
 12 files changed, 91 insertions(+), 9 deletions(-)

diff --git a/bash-completion/paludis b/bash-completion/paludis
index 832bac7..770f78c 100644
--- a/bash-completion/paludis
+++ b/bash-completion/paludis
@@ -98,6 +98,7 @@ _paludis() {
         --compact \
         --no-compact"
     install_opts="--pretend -p \
+        --ask -? \
         --destinations -d \
         --preserve-world -1 \
         --add-to-world-spec \
@@ -114,6 +115,7 @@ _paludis() {
         --compact \
         ${deplist_opts}"
     uninstall_opts="--pretend -p \
+        --ask -? \
         --destinations -d \
         --preserve-world -1 \
         --show-reasons \
diff --git a/doc/faq/misfunctionality.html.part b/doc/faq/misfunctionality.html.part
index a43287f..ef6ba64 100644
--- a/doc/faq/misfunctionality.html.part
+++ b/doc/faq/misfunctionality.html.part
@@ -6,7 +6,6 @@
     <li><a href="misfunctionality.html#wgetresume">wget Resume Support</a></li>
     <li><a href="misfunctionality.html#skipfirst">Build Resume / Skip First Support</a></li>
     <li><a href="misfunctionality.html#nice">No Automatic Niceness Support</a></li>
-    <li><a href="misfunctionality.html#ask">No Ask Support</a></li>
     <li><a href="misfunctionality.html#xtermtitles">Restoring XTerm Titles</a></li>
     <li><a href="misfunctionality.html#ecompress">No Automatic Manpage / Documentation Compression</a></li>
 </ul>
@@ -63,14 +62,6 @@ elegant.</p>
 <p>Rationale: Learn how to use <code>nice</code>. There's no
 <code>GCC_NICENESS</code> or <code>VIM_NICENESS</code> either.</p>
 
-<h2 id="ask">No Ask Support</h2>
-
-<p>Non-Problem: There's nothing like <code>emerge --ask</code>.</p>
-
-<p>Rationale: the <code>paludis</code> client is non-interactive. If someone is
-making an interactive client, there are much better ways of doing it than
-the limited functionality that <code>emerge --ask</code> provides.</p>
-
 <h2 id="xtermtitles">Restoring XTerm Titles</h2>
 
 <p>Non-Problem: Paludis doesn't restore the xterm title on exit.</p>
diff --git a/paludis/args/legacy/install_args_group.cc b/paludis/args/legacy/install_args_group.cc
index efbb948..c9306cd 100644
--- a/paludis/args/legacy/install_args_group.cc
+++ b/paludis/args/legacy/install_args_group.cc
@@ -33,6 +33,7 @@ InstallArgsGroup::InstallArgsGroup(ArgsSection * h, const std::string & our_name
     ArgsGroup(h, our_name, our_description),
 
     a_pretend(this, "pretend", 'p', "Pretend only", false),
+    a_ask(this, "ask", '?', "Ask before executing", false),
     a_destinations(this, "destinations", 'd', "Use specified destinations instead of defaults"),
     a_preserve_world(this, "preserve-world", '1', "Don't modify the world file", true),
     a_add_to_world_spec(this, "add-to-world-spec", '\0',
diff --git a/paludis/args/legacy/install_args_group.hh b/paludis/args/legacy/install_args_group.hh
index acada1e..b343234 100644
--- a/paludis/args/legacy/install_args_group.hh
+++ b/paludis/args/legacy/install_args_group.hh
@@ -64,6 +64,9 @@ namespace paludis
                 /// --pretend
                 paludis::args::SwitchArg a_pretend;
 
+                /// --ask
+                paludis::args::SwitchArg a_ask;
+
                 /// --destinations
                 paludis::args::StringSetArg a_destinations;
 
diff --git a/paludis/legacy/install_task.cc b/paludis/legacy/install_task.cc
index 8450fef..3f5d770 100644
--- a/paludis/legacy/install_task.cc
+++ b/paludis/legacy/install_task.cc
@@ -129,6 +129,7 @@ namespace paludis
         std::shared_ptr<const DestinationsSet> destinations;
 
         bool pretend;
+        bool ask;
         bool fetch_only;
         bool preserve_world;
         bool safe_resume;
@@ -156,6 +157,7 @@ namespace paludis
             targets(std::make_shared<SetSpecTree>(std::make_shared<AllDepSpec>())),
             destinations(d),
             pretend(false),
+            ask(false),
             fetch_only(false),
             preserve_world(false),
             safe_resume(false),
@@ -820,6 +822,9 @@ InstallTask::_pretend()
 
     on_pretend_all_post();
 
+    if (! _imp->pretend && ! _imp->fetch_only && _imp->ask && ! on_ask())
+        set_pretend(true);
+
     if (_imp->pretend)
     {
         if (0 != perform_hook(Hook("install_pretend_post")
@@ -1346,6 +1351,17 @@ InstallTask::execute()
                 ,
                 make_null_shared_ptr()).max_exit_status())
         throw ActionAbortedError("Install task execute aborted by hook");
+    if (_imp->fetch_only && _imp->ask)
+    {
+        set_fetch_only(false);
+        if (on_ask())
+            _main_actions();
+        else
+        {
+            set_pretend(true);
+            _pretend();
+        }
+    }
 }
 
 const DepList &
@@ -1367,6 +1383,12 @@ InstallTask::set_pretend(const bool value)
 }
 
 void
+InstallTask::set_ask(const bool value)
+{
+    _imp->ask = value;
+}
+
+void
 InstallTask::set_preserve_world(const bool value)
 {
     _imp->preserve_world = value;
diff --git a/paludis/legacy/install_task.hh b/paludis/legacy/install_task.hh
index fc488ba..8186cdf 100644
--- a/paludis/legacy/install_task.hh
+++ b/paludis/legacy/install_task.hh
@@ -111,6 +111,7 @@ namespace paludis
 
             void set_fetch_only(const bool value);
             void set_pretend(const bool value);
+            void set_ask(const bool value);
             void set_preserve_world(const bool value);
             void set_add_to_world_spec(const std::string &);
             void set_safe_resume(const bool);
@@ -166,6 +167,8 @@ namespace paludis
             virtual void on_pretend_post(const DepListEntry &) = 0;
             virtual void on_pretend_all_post() = 0;
 
+            virtual bool on_ask() = 0;
+
             virtual void on_fetch_all_pre() = 0;
             virtual void on_fetch_pre(const DepListEntry &, const int x, const int y, const int s, const int f) = 0;
             virtual void on_fetch_post(const DepListEntry &, const int x, const int y, const int s, const int f) = 0;
diff --git a/paludis/legacy/uninstall_task.cc b/paludis/legacy/uninstall_task.cc
index 45aa3d3..c91b357 100644
--- a/paludis/legacy/uninstall_task.cc
+++ b/paludis/legacy/uninstall_task.cc
@@ -95,6 +95,7 @@ namespace paludis
         std::list<std::shared_ptr<const PackageDepSpec> > targets;
 
         bool pretend;
+        bool ask;
         bool preserve_world;
         bool all_versions;
         bool with_unused_dependencies;
@@ -108,6 +109,7 @@ namespace paludis
         Imp<UninstallTask>(Environment * const e) :
             env(e),
             pretend(false),
+            ask(false),
             preserve_world(false),
             all_versions(false),
             with_unused_dependencies(false),
@@ -143,6 +145,12 @@ UninstallTask::set_pretend(const bool v)
 }
 
 void
+UninstallTask::set_ask(const bool v)
+{
+    _imp->ask = v;
+}
+
+void
 UninstallTask::set_preserve_world(const bool v)
 {
     _imp->preserve_world = v;
@@ -313,6 +321,10 @@ UninstallTask::execute()
         return;
     }
 
+    if (_imp->ask && ! on_ask())
+        return;
+
+
     if (_imp->preserve_world)
         on_preserve_world();
     else
diff --git a/paludis/legacy/uninstall_task.hh b/paludis/legacy/uninstall_task.hh
index e646557..b4db4f1 100644
--- a/paludis/legacy/uninstall_task.hh
+++ b/paludis/legacy/uninstall_task.hh
@@ -113,6 +113,7 @@ namespace paludis
             ///\{
 
             void set_pretend(const bool value);
+            void set_ask(const bool value);
             void set_preserve_world(const bool value);
             void set_all_versions(const bool value);
             void set_with_unused_dependencies(const bool value);
@@ -139,6 +140,8 @@ namespace paludis
             virtual void on_display_unmerge_list_post() = 0;
             virtual void on_display_unmerge_list_entry(const UninstallListEntry &) = 0;
 
+            virtual bool on_ask() = 0;
+
             virtual void on_uninstall_all_pre() = 0;
             virtual void on_uninstall_pre(const UninstallListEntry &) = 0;
             virtual void on_uninstall_post(const UninstallListEntry &) = 0;
diff --git a/src/clients/paludis/uninstall.cc b/src/clients/paludis/uninstall.cc
index cbade32..d1a5b0a 100644
--- a/src/clients/paludis/uninstall.cc
+++ b/src/clients/paludis/uninstall.cc
@@ -164,6 +164,25 @@ namespace
                 cout << endl;
             }
 
+            virtual bool on_ask()
+            {
+                if (_count == 0)
+                    return true;
+                std::string answer;
+                cout << endl << "* Do you really want to do this ? [Y/n] ... ";
+                while (true)
+                {
+                    getline(std::cin, answer);
+                    for (int i(0) ; i < answer.length() ; ++i)
+                        answer[i] = tolower(answer[i]);
+                    if (answer == "no" || answer == "n")
+                        return false;
+                    else if (answer == "yes" || answer == "ye" || answer == "y" || answer == "")
+                        return true;
+                    cout << endl << "Unknown answer : " + answer + " [Y/n] ... ";
+                }
+            }
+
             virtual void on_uninstall_all_pre()
             {
             }
@@ -231,6 +250,7 @@ namespace
         OurUninstallTask task(env);
 
         task.set_pretend(CommandLine::get_instance()->install_args.a_pretend.specified());
+        task.set_ask(CommandLine::get_instance()->install_args.a_ask.specified());
         task.set_preserve_world(CommandLine::get_instance()->install_args.a_preserve_world.specified());
         task.set_with_unused_dependencies(CommandLine::get_instance()->a_with_unused_dependencies.specified());
         task.set_with_dependencies(CommandLine::get_instance()->a_with_dependencies.specified());
diff --git a/src/output/console_install_task.cc b/src/output/console_install_task.cc
index d64030f..0107bcb 100644
--- a/src/output/console_install_task.cc
+++ b/src/output/console_install_task.cc
@@ -573,6 +573,28 @@ ConsoleInstallTask::on_pretend_all_post()
 {
 }
 
+bool
+ConsoleInstallTask::on_ask()
+{
+    if (count<max_count>() == 0)
+        return true;
+    std::string answer;
+    output_endl();
+    output_starred_item_no_endl("Do you really want to do this ? [Y/n] ... ");
+    while (true)
+    {
+        getline(std::cin, answer);
+        for (int i(0) ; i < answer.length() ; ++i)
+            answer[i] = tolower(answer[i]);
+        if (answer == "no" || answer == "n")
+            return false;
+        else if (answer == "yes" || answer == "ye" || answer == "y" || answer == "")
+            return true;
+        output_endl();
+        output_no_endl("Unknown answer : " + answer + " [Y/n] ... ");
+    }
+}
+
 void
 ConsoleInstallTask::on_fetch_all_pre()
 {
diff --git a/src/output/console_install_task.hh b/src/output/console_install_task.hh
index 85ae9b1..c510cbe 100644
--- a/src/output/console_install_task.hh
+++ b/src/output/console_install_task.hh
@@ -145,6 +145,8 @@ namespace paludis
             virtual void on_pretend_post(const DepListEntry &);
             virtual void on_pretend_all_post();
 
+            virtual bool on_ask();
+
             virtual void on_fetch_all_pre();
             virtual void on_fetch_pre(const DepListEntry &, const int x, const int y, const int s, const int f);
             virtual void on_fetch_post(const DepListEntry &, const int x, const int y, const int s, const int f);
diff --git a/zsh-completion/_paludis b/zsh-completion/_paludis
index f3fb939..e32cad4 100644
--- a/zsh-completion/_paludis
+++ b/zsh-completion/_paludis
@@ -19,6 +19,7 @@ _paludis() {
 
     install_uninstall_args=(
         "(--pretend -p)"{--pretend,-p}"[Pretend only]"
+        "(--ask -?)"{--ask,-?}"[Ask before executing]"
         "(--destinations -d)"{--destinations,-d}"[Use specified destinations instead of defaults]:Destinations:_paludis_packages repositories"
         "(--preserve-world -1)"{--preserve-world,-1}"[Don't modify the world file]"
         "--add-to-world-spec[Use this atom, rather than all targets, for updating world (for resume commands)]"
-- 
1.7.4.rc1.5.ge17aa.dirty

