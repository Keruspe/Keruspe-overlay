From b1e1757c72b4c1bf04c637909edf47c348e01951 Mon Sep 17 00:00:00 2001
From: Marc-Antoine Perennou <Marc-Antoine@Perennou.com>
Date: Sun, 27 Jun 2010 16:18:02 +0200
Subject: [PATCH 2/2] paludis ask

---
 bash-completion/paludis            |    2 ++
 doc/faq/misfunctionality.html.part |    8 --------
 paludis/args/install_args_group.cc |    2 ++
 paludis/args/install_args_group.hh |    3 +++
 paludis/install_task.cc            |   22 ++++++++++++++++++++++
 paludis/install_task.hh            |    3 +++
 paludis/uninstall_task.cc          |   11 +++++++++++
 paludis/uninstall_task.hh          |    3 +++
 src/clients/paludis/uninstall.cc   |   20 ++++++++++++++++++++
 src/output/console_install_task.cc |   22 ++++++++++++++++++++++
 src/output/console_install_task.hh |    2 ++
 zsh-completion/_paludis            |    1 +
 12 files changed, 91 insertions(+), 8 deletions(-)

diff --git a/bash-completion/paludis b/bash-completion/paludis
index 832bac7..09cc5e8 100644
--- a/bash-completion/paludis
+++ b/bash-completion/paludis
@@ -98,6 +98,7 @@ _paludis() {
         --compact \
         --no-compact"
     install_opts="--pretend -p \
+        --ask -a \
         --destinations -d \
         --preserve-world -1 \
         --add-to-world-spec \
@@ -114,6 +115,7 @@ _paludis() {
         --compact \
         ${deplist_opts}"
     uninstall_opts="--pretend -p \
+        --ask -a \
         --destinations -d \
         --preserve-world -1 \
         --show-reasons \
diff --git a/doc/faq/misfunctionality.html.part b/doc/faq/misfunctionality.html.part
index a43287f..6416974 100644
--- a/doc/faq/misfunctionality.html.part
+++ b/doc/faq/misfunctionality.html.part
@@ -63,14 +63,6 @@ elegant.</p>
 <p>Rationale: Learn how to use <code>nice</code>. There's no
 <code>GCC_NICENESS</code> or <code>VIM_NICENESS</code> either.</p>
 
-<h2 id="ask">No Ask Support</h2>
-
-<p>Non-Problem: There's nothing like <code>emerge --ask</code>.</p>
-
-<p>Rationale: the <code>paludis</code> client is non-interactive. If someone is
-making an interactive client, there are much better ways of doing it than
-the limited functionality that <code>emerge --ask</code> provides.</p>
-
 <h2 id="xtermtitles">Restoring XTerm Titles</h2>
 
 <p>Non-Problem: Paludis doesn't restore the xterm title on exit.</p>
diff --git a/paludis/args/install_args_group.cc b/paludis/args/install_args_group.cc
index afb8533..e135c4a 100644
--- a/paludis/args/install_args_group.cc
+++ b/paludis/args/install_args_group.cc
@@ -33,6 +33,7 @@ InstallArgsGroup::InstallArgsGroup(ArgsSection * h, const std::string & our_name
     ArgsGroup(h, our_name, our_description),
 
     a_pretend(this, "pretend", 'p', "Pretend only", false),
+    a_ask(this, "ask", 'a', "Ask before executing", false),
     a_destinations(this, "destinations", 'd', "Use specified destinations instead of defaults"),
     a_preserve_world(this, "preserve-world", '1', "Don't modify the world file", true),
     a_add_to_world_spec(this, "add-to-world-spec", '\0',
@@ -121,6 +122,7 @@ InstallArgsGroup::populate_install_task(const Environment *, InstallTask & task)
 {
     task.set_fetch_only(a_fetch.specified());
     task.set_pretend(a_pretend.specified());
+    task.set_ask(a_ask.specified());
     task.set_preserve_world(a_preserve_world.specified());
     task.set_safe_resume(! a_no_safe_resume.specified());
 
diff --git a/paludis/args/install_args_group.hh b/paludis/args/install_args_group.hh
index 4f392f8..9ce79ba 100644
--- a/paludis/args/install_args_group.hh
+++ b/paludis/args/install_args_group.hh
@@ -64,6 +64,9 @@ namespace paludis
                 /// --pretend
                 paludis::args::SwitchArg a_pretend;
 
+                /// --ask
+                paludis::args::SwitchArg a_ask;
+
                 /// --destinations
                 paludis::args::StringSetArg a_destinations;
 
diff --git a/paludis/install_task.cc b/paludis/install_task.cc
index c1938bb..588b467 100644
--- a/paludis/install_task.cc
+++ b/paludis/install_task.cc
@@ -131,6 +131,7 @@ namespace paludis
         std::tr1::shared_ptr<const DestinationsSet> destinations;
 
         bool pretend;
+        bool ask;
         bool fetch_only;
         bool preserve_world;
         bool safe_resume;
@@ -158,6 +159,7 @@ namespace paludis
             targets(new SetSpecTree(make_shared_ptr(new AllDepSpec))),
             destinations(d),
             pretend(false),
+            ask(false),
             fetch_only(false),
             preserve_world(false),
             safe_resume(false),
@@ -802,6 +804,9 @@ InstallTask::_pretend()
 
     on_pretend_all_post();
 
+    if (! _imp->pretend && ! _imp->fetch_only && _imp->ask && ! on_ask())
+        set_pretend(true);
+
     if (_imp->pretend)
     {
         if (0 != perform_hook(Hook("install_pretend_post")
@@ -1315,6 +1320,17 @@ InstallTask::execute()
                 ("DEPLIST_HAS_ERRORS", stringify(_imp->dep_list.has_errors()))
                 ).max_exit_status())
         throw ActionAbortedError("Install task execute aborted by hook");
+    if (_imp->fetch_only && _imp->ask)
+    {
+        set_fetch_only(false);
+        if (on_ask())
+            _main_actions();
+        else
+        {
+            set_pretend(true);
+            _pretend();
+        }
+    }
 }
 
 const DepList &
@@ -1336,6 +1352,12 @@ InstallTask::set_pretend(const bool value)
 }
 
 void
+InstallTask::set_ask(const bool value)
+{
+    _imp->ask = value;
+}
+
+void
 InstallTask::set_preserve_world(const bool value)
 {
     _imp->preserve_world = value;
diff --git a/paludis/install_task.hh b/paludis/install_task.hh
index f0d0287..68eda56 100644
--- a/paludis/install_task.hh
+++ b/paludis/install_task.hh
@@ -110,6 +110,7 @@ namespace paludis
 
             void set_fetch_only(const bool value);
             void set_pretend(const bool value);
+            void set_ask(const bool value);
             void set_preserve_world(const bool value);
             void set_add_to_world_spec(const std::string &);
             void set_safe_resume(const bool);
@@ -165,6 +166,8 @@ namespace paludis
             virtual void on_pretend_post(const DepListEntry &) = 0;
             virtual void on_pretend_all_post() = 0;
 
+            virtual bool on_ask() = 0;
+
             virtual void on_fetch_all_pre() = 0;
             virtual void on_fetch_pre(const DepListEntry &, const int x, const int y, const int s, const int f) = 0;
             virtual void on_fetch_post(const DepListEntry &, const int x, const int y, const int s, const int f) = 0;
diff --git a/paludis/uninstall_task.cc b/paludis/uninstall_task.cc
index 70ea16e..a44269c 100644
--- a/paludis/uninstall_task.cc
+++ b/paludis/uninstall_task.cc
@@ -92,6 +92,7 @@ namespace paludis
         std::list<std::tr1::shared_ptr<const PackageDepSpec> > targets;
 
         bool pretend;
+        bool ask;
         bool preserve_world;
         bool all_versions;
         bool with_unused_dependencies;
@@ -105,6 +106,7 @@ namespace paludis
         Implementation<UninstallTask>(Environment * const e) :
             env(e),
             pretend(false),
+            ask(false),    
             preserve_world(false),
             all_versions(false),
             with_unused_dependencies(false),
@@ -140,6 +142,12 @@ UninstallTask::set_pretend(const bool v)
 }
 
 void
+UninstallTask::set_ask(const bool v)
+{
+    _imp->ask = v;
+}
+
+void
 UninstallTask::set_preserve_world(const bool v)
 {
     _imp->preserve_world = v;
@@ -310,6 +318,9 @@ UninstallTask::execute()
         return;
     }
 
+    if (_imp->ask && ! on_ask())
+        return;
+
     if (_imp->preserve_world)
         on_preserve_world();
     else
diff --git a/paludis/uninstall_task.hh b/paludis/uninstall_task.hh
index b2af2f9..6ec2576 100644
--- a/paludis/uninstall_task.hh
+++ b/paludis/uninstall_task.hh
@@ -112,6 +112,7 @@ namespace paludis
             ///\{
 
             void set_pretend(const bool value);
+            void set_ask(const bool value);
             void set_preserve_world(const bool value);
             void set_all_versions(const bool value);
             void set_with_unused_dependencies(const bool value);
@@ -138,6 +139,8 @@ namespace paludis
             virtual void on_display_unmerge_list_post() = 0;
             virtual void on_display_unmerge_list_entry(const UninstallListEntry &) = 0;
 
+            virtual bool on_ask() = 0;
+
             virtual void on_uninstall_all_pre() = 0;
             virtual void on_uninstall_pre(const UninstallListEntry &) = 0;
             virtual void on_uninstall_post(const UninstallListEntry &) = 0;
diff --git a/src/clients/paludis/uninstall.cc b/src/clients/paludis/uninstall.cc
index 60f9ff3..2ce3105 100644
--- a/src/clients/paludis/uninstall.cc
+++ b/src/clients/paludis/uninstall.cc
@@ -163,6 +163,25 @@ namespace
                 cout << endl;
             }
 
+            virtual bool on_ask()
+            {
+                if (_count == 0)
+                    return true;
+                std::string answer;
+                cout << endl << "* Do you really want to do this ? [Y/n] ... ";
+                while (true)
+                {
+                    getline(std::cin, answer);
+                    for (int i(0) ; i < answer.length() ; ++i)
+                        answer[i] = tolower(answer[i]);
+                    if (answer == "no" || answer == "n")
+                        return false;
+                    else if (answer == "yes" || answer == "ye" || answer == "y" || answer == "")
+                        return true;
+                    cout << endl << "Unknown answer : " + answer + " [Y/n] ... ";
+                }
+            }
+
             virtual void on_uninstall_all_pre()
             {
             }
@@ -230,6 +249,7 @@ namespace
         OurUninstallTask task(env);
 
         task.set_pretend(CommandLine::get_instance()->install_args.a_pretend.specified());
+        task.set_ask(CommandLine::get_instance()->install_args.a_ask.specified());
         task.set_preserve_world(CommandLine::get_instance()->install_args.a_preserve_world.specified());
         task.set_with_unused_dependencies(CommandLine::get_instance()->a_with_unused_dependencies.specified());
         task.set_with_dependencies(CommandLine::get_instance()->a_with_dependencies.specified());
diff --git a/src/output/console_install_task.cc b/src/output/console_install_task.cc
index e9dacaa..f92e66e 100644
--- a/src/output/console_install_task.cc
+++ b/src/output/console_install_task.cc
@@ -574,6 +574,28 @@ ConsoleInstallTask::on_pretend_all_post()
 {
 }
 
+bool
+ConsoleInstallTask::on_ask()
+{
+    if (count<max_count>() == 0)
+        return true;
+    std::string answer;
+    output_endl();
+    output_starred_item_no_endl("Do you really want to do this ? [Y/n] ... ");
+    while (true)
+    {
+        getline(std::cin, answer);
+        for (int i(0) ; i < answer.length() ; ++i)
+            answer[i] = tolower(answer[i]);
+        if (answer == "no" || answer == "n")
+            return false;
+        else if (answer == "yes" || answer == "ye" || answer == "y" || answer == "")
+            return true;
+        output_endl();
+        output_no_endl("Unknown answer : " + answer + " [Y/n] ... ");
+    }
+}
+
 void
 ConsoleInstallTask::on_fetch_all_pre()
 {
diff --git a/src/output/console_install_task.hh b/src/output/console_install_task.hh
index 422ab5f..9d4d2f3 100644
--- a/src/output/console_install_task.hh
+++ b/src/output/console_install_task.hh
@@ -145,6 +145,8 @@ namespace paludis
             virtual void on_pretend_post(const DepListEntry &);
             virtual void on_pretend_all_post();
 
+            virtual bool on_ask();
+
             virtual void on_fetch_all_pre();
             virtual void on_fetch_pre(const DepListEntry &, const int x, const int y, const int s, const int f);
             virtual void on_fetch_post(const DepListEntry &, const int x, const int y, const int s, const int f);
diff --git a/zsh-completion/_paludis b/zsh-completion/_paludis
index f3fb939..8049d1f 100644
--- a/zsh-completion/_paludis
+++ b/zsh-completion/_paludis
@@ -19,6 +19,7 @@ _paludis() {
 
     install_uninstall_args=(
         "(--pretend -p)"{--pretend,-p}"[Pretend only]"
+        "(--ask -a)"{--ask,-a}"[Ask before executing]"
         "(--destinations -d)"{--destinations,-d}"[Use specified destinations instead of defaults]:Destinations:_paludis_packages repositories"
         "(--preserve-world -1)"{--preserve-world,-1}"[Don't modify the world file]"
         "--add-to-world-spec[Use this atom, rather than all targets, for updating world (for resume commands)]"
-- 
1.7.1

